<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©vision des mots de vocabulaire de Cl√©mence LOPEZ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card { perspective: 1000px; }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.is-flipped .card-inner { transform: rotateY(180deg); }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            text-align: center;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .card-back { transform: rotateY(180deg); }
        .mode-btn {
            border: 1px solid #d1d5db;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            background-color: white;
        }
        .mode-btn.active {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
            border-color: #3b82f6;
        }
        .tab-container {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        .tab-btn {
            position: relative;
            padding: 1rem 2rem;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            background: transparent;
            color: #64748b;
            transition: all 0.3s ease;
            cursor: pointer;
            border-radius: 0.75rem 0.75rem 0 0;
        }
        .tab-btn:hover {
            color: #3b82f6;
            background-color: #f1f5f9;
        }
        .tab-btn.active {
            color: #3b82f6;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 3px 3px 0 0;
        }
        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 1rem 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
        }
        .tab-content.active {
            display: block;
        }
        .qcm-option-btn {
            transition: all 0.2s;
            border: 1px solid #d1d5db;
        }
        .qcm-question {
            background-color: #dbeafe;
            color: #1e40af;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            margin-bottom: 1.5rem;
        }
        .tooltip {
            position: relative;
            cursor: pointer;
        }
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 10;
            margin-bottom: 0.25rem;
            pointer-events: none;
        }
        .tooltip:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: #1f2937;
            z-index: 10;
            pointer-events: none;
        }
        .feedback-box {
            background-color: #f3f4f6;
            border: 2px solid #d1d5db;
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 1rem 0;
        }
        .timer {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .filter-btn {
            border: 1px solid #d1d5db;
            padding: 0.4rem 0.8rem;
            border-radius: 0.4rem;
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.2s;
            background-color: white;
        }
        .filter-btn.active-review {
            background-color: #dc2626;
            color: white;
            border-color: #dc2626;
        }
        .filter-btn.active-correct {
            background-color: #16a34a;
            color: white;
            border-color: #16a34a;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible-content.open {
            max-height: 500px;
        }
        .session-timer.warning {
            color: #dc2626 !important;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .word-item {
            transition: all 0.2s;
        }
        .word-item:hover {
            background-color: #f3f4f6;
        }
        .word-checkbox {
            width: 1.2rem;
            height: 1.2rem;
        }
        .keyboard-help {
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 0.875rem;
            color: #475569;
        }
        .date-badge {
            background-color: #e0e7ff;
            color: #3730a3;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }
        .filter-controls {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .clickable-word {
            cursor: pointer;
            transition: all 0.2s;
        }
        .clickable-word:hover {
            background-color: #f3f4f6;
            border-radius: 0.25rem;
        }
        .translation-popup {
            position: absolute;
            background-color: #1f2937;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            z-index: 20;
            pointer-events: none;
            white-space: nowrap;
        }
        .translation-popup::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 sm:p-6 md:p-8 min-h-screen flex flex-col">

    <!-- Modal pour la dur√©e de session -->
    <div id="session-duration-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-blue-600 mb-4 text-center">üéØ Configuration de la session</h2>
            <p class="text-gray-600 mb-4 text-center">Combien de temps veux-tu √©tudier aujourd'hui ?</p>
            <div class="space-y-3">
                <button class="duration-btn w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg" data-minutes="10">‚ö° 10 minutes</button>
                <button class="duration-btn w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg" data-minutes="15">üìö 15 minutes</button>
                <button class="duration-btn w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg" data-minutes="20">üöÄ 20 minutes</button>
                <button class="duration-btn w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg" data-minutes="30">üí™ 30 minutes</button>
                <div class="flex items-center gap-2 mt-4">
                    <input type="number" id="custom-duration" min="1" max="120" placeholder="Autre dur√©e" class="flex-1 p-2 border border-gray-300 rounded">
                    <span class="text-sm text-gray-500">minutes</span>
                    <button id="custom-duration-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour nouveau lien Google Sheet -->
    <div id="sheet-error-modal" class="modal hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-red-600 mb-4 text-center">‚ùå Erreur de chargement</h2>
            <p class="text-gray-600 mb-4">La liste de mots n'a pas pu √™tre charg√©e. Veuillez entrer un nouveau lien Google Sheet :</p>
            <div class="space-y-3">
                <input type="url" id="new-sheet-url" placeholder="https://docs.google.com/..." class="w-full p-3 border border-gray-300 rounded-lg">
                <p class="text-xs text-gray-500">Exemple de lien valide :</p>
                <p class="text-xs text-blue-600 bg-blue-50 p-2 rounded break-all" id="example-url-display"></p>
                <div class="flex gap-2">
                    <button id="use-example-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Utiliser l'exemple</button>
                    <button id="validate-new-sheet-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Valider</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8 flex-grow">
        
        <main class="lg:col-span-2 space-y-6">
            <header class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-blue-600">R√©vision des mots de vocabulaire de Cl√©mence LOPEZ</h1>
                <div class="mt-2 flex justify-center items-center gap-4">
                    <div class="timer text-blue-600" id="session-timer-container">‚è±Ô∏è <span id="session-timer">00:00</span></div>
                    <button id="reset-session-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-sm">üîÑ Reset Session</button>
                </div>
            </header>

            <!-- Onglets am√©lior√©s -->
            <div class="tab-container">
                <button id="tab-exercise" class="tab-btn active">üéØ Exercices</button>
                <button id="tab-wordlist" class="tab-btn">üìù Liste des mots</button>
            </div>

            <!-- Contenu onglet Exercices -->
            <div id="content-exercise" class="tab-content active">
                <div id="exercise-mode-selection" class="flex justify-center gap-2 sm:gap-4 flex-wrap mb-6">
                    <button data-mode="mix" class="mode-btn">üöÄ Mix</button>
                    <button data-mode="flashcard-es-fr" class="mode-btn">üá™üá∏ ‚Üí üá´üá∑ Flashcard</button>
                    <button data-mode="flashcard-fr-es" class="mode-btn">üá´üá∑ ‚Üí üá™üá∏ Flashcard</button>
                    <button data-mode="qcm" class="mode-btn">üß† QCM</button>
                </div>

                <div class="flex justify-center gap-2 flex-wrap mb-6">
                    <button id="review-filter-btn" class="filter-btn">üéØ R√©viser uniquement les mots √† r√©viser</button>
                    <button id="correct-filter-btn" class="filter-btn">‚úÖ R√©viser uniquement les mots corrects</button>
                    <button id="custom-filter-btn" class="filter-btn">‚≠ê R√©viser uniquement mes mots choisis</button>
                </div>

                <!-- Filtre par date -->
                <div class="filter-controls">
                    <div class="flex flex-wrap items-center justify-center gap-4">
                        <div class="flex items-center gap-2">
                            <label for="date-filter" class="text-sm font-medium text-gray-700">üìÖ Filtrer par date :</label>
                            <select id="date-filter" class="px-3 py-2 border border-gray-300 rounded-md text-sm bg-white">
                                <option value="">Toutes les dates</option>
                            </select>
                            <button id="clear-date-filter" class="px-3 py-2 bg-gray-500 text-white rounded-md text-sm hover:bg-gray-600">Effacer</button>
                        </div>
                        <button id="sort-by-date" class="px-4 py-2 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600">üìÖ Trier par date ‚Üì</button>
                    </div>
                </div>

                <!-- Aide clavier -->
                <div class="keyboard-help text-center">
                    <strong>‚å®Ô∏è Raccourcis clavier :</strong>
                    <span class="mx-2">‚Üê Mot pr√©c√©dent</span>
                    <span class="mx-2">‚Üí Mot suivant</span>
                    <span class="mx-2">‚Üµ Valider</span>
                    <span class="mx-2">‚Üë Accepter r√©ponse</span>
                    <span class="mx-2">Espace Voir r√©ponse</span>
                </div>
                
                <div id="exercise-container" class="h-64 sm:h-72">
                    <!-- L'exercice (carte ou QCM) sera inject√© ici -->
                </div>
                
                <div id="answer-section" class="mt-4 space-y-3 min-h-[120px]">
                    <input type="text" id="answer-input" placeholder="√âcrivez la traduction ici..." autocomplete="off" class="w-full max-w-md mx-auto block p-3 border border-gray-300 rounded-lg text-center text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    <div id="qcm-options" class="flex flex-col items-center gap-3 w-full max-w-md mx-auto"></div>
                    <div id="feedback" class="text-center min-h-[60px] font-semibold pt-2"></div>
                </div>

                <div id="controls" class="flex justify-center gap-4 flex-wrap">
                    <button id="prev-btn" class="bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-600 transition-transform transform hover:scale-105">
                        ‚¨ÖÔ∏è Mot Pr√©c√©dent
                    </button>
                     <button id="check-btn" class="bg-blue-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-600 transition-transform transform hover:scale-105">
                        V√©rifier
                    </button>
                    <button id="dont-know-btn" class="bg-orange-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-orange-600 transition-transform transform hover:scale-105">
                        Je ne sais pas
                    </button>
                    <button id="accept-answer-btn" class="hidden bg-green-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-600 transition-transform transform hover:scale-105">
                        Accepter ma r√©ponse
                    </button>
                    <button id="next-btn" class="hidden bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-800 transition-transform transform hover:scale-105">
                        Mot Suivant ‚û°Ô∏è
                    </button>
                </div>
            </div>

            <!-- Contenu onglet Liste des mots -->
            <div id="content-wordlist" class="tab-content">
                <h2 class="text-2xl font-bold text-blue-600 mb-4 text-center">üìù Ma liste de mots</h2>
                <p class="text-gray-600 text-center mb-6">Coche les mots que tu veux r√©viser sp√©cialement ‚≠ê</p>
                
                <!-- Filtre par date dans l'onglet liste -->
                <div class="filter-controls">
                    <div class="flex flex-wrap items-center justify-center gap-4">
                        <div class="flex items-center gap-2">
                            <label for="date-filter-wordlist" class="text-sm font-medium text-gray-700">üìÖ Filtrer par date :</label>
                            <select id="date-filter-wordlist" class="px-3 py-2 border border-gray-300 rounded-md text-sm bg-white">
                                <option value="">Toutes les dates</option>
                            </select>
                            <button id="clear-date-filter-wordlist" class="px-3 py-2 bg-gray-500 text-white rounded-md text-sm hover:bg-gray-600">Effacer</button>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-2 max-h-96 overflow-y-auto mb-6">
                    <div id="words-list-container">
                        <!-- Les mots seront inject√©s ici -->
                    </div>
                </div>
                
                <div class="text-center">
                    <button id="save-custom-selection" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">
                        üíæ Sauvegarder ma s√©lection
                    </button>
                </div>
            </div>
        </main>

        <aside class="space-y-8">
            <div>
                <h2 class="text-2xl font-semibold mb-4 text-blue-600">Tableau de Bord</h2>
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-xl shadow">
                        <h3 class="font-bold mb-2 text-purple-500">üìä Session en cours</h3>
                        <div class="text-sm space-y-1">
                            <div class="flex justify-between">
                                <span>Mots r√©vis√©s :</span>
                                <span id="session-total" class="font-mono font-bold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>‚úÖ Correctes :</span>
                                <span id="session-correct" class="font-mono font-bold text-green-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>‚ùå Incorrectes :</span>
                                <span id="session-incorrect" class="font-mono font-bold text-red-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>ü§∑ Je ne sais pas :</span>
                                <span id="session-unknown" class="font-mono font-bold text-orange-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>üìà Accept√©es :</span>
                                <span id="session-accepted" class="font-mono font-bold text-blue-600">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow">
                        <h3 class="font-bold mb-2 text-green-500">‚úÖ Mots corrects (session)</h3>
                        <ul id="words-correct-session" class="space-y-2 text-sm max-h-48 overflow-y-auto pr-2"></ul>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow">
                        <h3 class="font-bold mb-2 text-red-500">‚ùå Mots √† r√©viser (session)</h3>
                        <ul id="words-to-review" class="space-y-2 text-sm max-h-48 overflow-y-auto pr-2"></ul>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow">
                        <h3 class="font-bold mb-2 text-orange-500">üß† Mots √† apprendre</h3>
                        <ul id="words-to-learn" class="space-y-2 text-sm max-h-48 overflow-y-auto pr-2"></ul>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow">
                        <h3 class="font-bold mb-2 text-green-500">üèÜ Mots ma√Ætris√©s</h3>
                        <ul id="words-learned" class="space-y-2 text-sm max-h-48 overflow-y-auto pr-2"></ul>
                    </div>
                </div>
            </div>

            <!-- Section tableau des mots -->
            <div class="bg-white p-4 rounded-xl shadow">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-gray-700">üìã Liste compl√®te des mots</h3>
                    <button id="toggle-words-table" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded text-sm">
                        üëÅÔ∏è Voir
                    </button>
                </div>
                <div id="words-table-container" class="collapsible-content">
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="text-left p-2 border-b">Date</th>
                                    <th class="text-left p-2 border-b">Espagnol</th>
                                    <th class="text-left p-2 border-b">Fran√ßais</th>
                                    <th class="text-center p-2 border-b">Niveau</th>
                                </tr>
                            </thead>
                            <tbody id="words-table-body">
                                <!-- Les mots seront inject√©s ici -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div>
                <h2 class="text-2xl font-semibold mb-4 text-blue-600">Lien Google Sheet</h2>
                 <div class="bg-white p-4 rounded-xl shadow">
                    <p class="text-sm text-gray-600 mb-2">
                        Publiez votre Google Sheet sur le web (format CSV) et collez le lien ici.
                    </p>
                    <input type="url" id="sheet-url-input" placeholder="https://docs.google.com/..." class="w-full border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    <button id="load-sheet-btn" class="mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md">
                        Charger la liste
                    </button>
                    <p id="sheet-feedback" class="text-xs text-center mt-2 h-auto"></p>
                 </div>
            </div>
        </aside>
    </div>

    <!-- Pied de page -->
    <footer class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-500">
        <p>Version 2.7 - 15/01/2025 16:30 | D√©velopp√© par <strong>David LOPEZ</strong> | √âcole <strong>IMAC</strong></p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // ‚≠ê CONFIGURATION CENTRALIS√âE - Lien Google Sheet unique
            const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbVypWe5G4ANd6EOF6Qv3zevzVB0JndrvFe4S88_ctRAp--7Ln2jxY8JQtTjRN7tDMJ2dweBB57LMm/pub?gid=0&single=true&output=csv";

            const state = {
                words: [],
                availableDates: [], // Dates disponibles dans les donn√©es
                currentWordIndex: null,
                wordHistory: [], // Historique des mots vus pour navigation
                historyPosition: -1, // Position actuelle dans l'historique
                learnedThreshold: 3,
                exerciseMode: 'mix', // 'mix', 'flashcard-es-fr', 'flashcard-fr-es', 'qcm'
                currentQuestion: {}, // { type, word, options, answer }
                sessionMistakes: [], // Mots rat√©s pendant cette session
                sessionCorrect: [], // Mots corrects pendant cette session
                customSelection: [], // Mots s√©lectionn√©s manuellement par l'enfant
                dateFilter: null, // Filtre par date
                sortByDateAsc: false, // Tri par date croissant ou d√©croissant (d√©faut d√©croissant)
                sessionStats: {
                    total: 0,
                    correct: 0,
                    incorrect: 0,
                    unknown: 0,
                    accepted: 0,
                    startTime: null
                },
                lastUserAnswer: '', // Pour pouvoir l'afficher dans le feedback
                reviewFilter: false, // Filtre pour ne r√©viser que les mots √† r√©viser
                correctFilter: false, // Filtre pour ne r√©viser que les mots corrects
                customFilter: false, // Filtre pour ne r√©viser que les mots choisis par l'enfant
                sessionDuration: 0, // Dur√©e de session en minutes
                sessionEndTime: null,
                twoMinuteWarningShown: false,
                isFirstSession: true, // Pour savoir si c'est la premi√®re session
                currentTab: 'exercise', // 'exercise' ou 'wordlist'
            };

            const exerciseContainer = document.getElementById('exercise-container');
            const wordsCorrectSessionList = document.getElementById('words-correct-session');
            const wordsToReviewList = document.getElementById('words-to-review');
            const wordsToLearnList = document.getElementById('words-to-learn');
            const wordsLearnedList = document.getElementById('words-learned');
            const sheetUrlInput = document.getElementById('sheet-url-input');
            const loadSheetBtn = document.getElementById('load-sheet-btn');
            const sheetFeedback = document.getElementById('sheet-feedback');
            const answerInput = document.getElementById('answer-input');
            const qcmOptionsContainer = document.getElementById('qcm-options');
            const feedback = document.getElementById('feedback');
            const checkBtn = document.getElementById('check-btn');
            const dontKnowBtn = document.getElementById('dont-know-btn');
            const acceptAnswerBtn = document.getElementById('accept-answer-btn');
            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');
            const modeButtons = document.querySelectorAll('.mode-btn');
            const sessionTimer = document.getElementById('session-timer');
            const sessionTimerContainer = document.getElementById('session-timer-container');
            const reviewFilterBtn = document.getElementById('review-filter-btn');
            const correctFilterBtn = document.getElementById('correct-filter-btn');
            const customFilterBtn = document.getElementById('custom-filter-btn');
            const resetSessionBtn = document.getElementById('reset-session-btn');
            const wordsTableContainer = document.getElementById('words-table-container');
            const toggleWordsTableBtn = document.getElementById('toggle-words-table');
            const wordsTableBody = document.getElementById('words-table-body');
            const wordsListContainer = document.getElementById('words-list-container');
            const saveCustomSelectionBtn = document.getElementById('save-custom-selection');
            
            // √âl√©ments pour les dates
            const dateFilterSelect = document.getElementById('date-filter');
            const clearDateFilterBtn = document.getElementById('clear-date-filter');
            const sortByDateBtn = document.getElementById('sort-by-date');
            const dateFilterWordlistSelect = document.getElementById('date-filter-wordlist');
            const clearDateFilterWordlistBtn = document.getElementById('clear-date-filter-wordlist');

            // √âl√©ments onglets
            const tabExercise = document.getElementById('tab-exercise');
            const tabWordlist = document.getElementById('tab-wordlist');
            const contentExercise = document.getElementById('content-exercise');
            const contentWordlist = document.getElementById('content-wordlist');

            // √âl√©ments modals
            const sessionDurationModal = document.getElementById('session-duration-modal');
            const sheetErrorModal = document.getElementById('sheet-error-modal');
            const durationBtns = document.querySelectorAll('.duration-btn');
            const customDurationBtn = document.getElementById('custom-duration-btn');
            const customDurationInput = document.getElementById('custom-duration');
            const newSheetUrlInput = document.getElementById('new-sheet-url');
            const useExampleBtn = document.getElementById('use-example-btn');
            const validateNewSheetBtn = document.getElementById('validate-new-sheet-btn');
            const exampleUrlDisplay = document.getElementById('example-url-display');

            // √âl√©ments des statistiques de session
            const sessionTotal = document.getElementById('session-total');
            const sessionCorrect = document.getElementById('session-correct');
            const sessionIncorrect = document.getElementById('session-incorrect');
            const sessionUnknown = document.getElementById('session-unknown');
            const sessionAccepted = document.getElementById('session-accepted');

            let timerInterval = null;
            let currentTranslationPopup = null;

            // Fonctions utilitaires pour les dates
            const parseDate = (dateString) => {
                if (!dateString) return null;
                try {
                    return new Date(dateString);
                } catch (e) {
                    return null;
                }
            };

            // Construction de la liste des dates disponibles
            const buildAvailableDates = () => {
                const dateSet = new Set();
                state.words.forEach(word => {
                    if (word.date) {
                        dateSet.add(word.date);
                    }
                });
                state.availableDates = Array.from(dateSet).sort((a, b) => {
                    const dateA = parseDate(a) || new Date(0);
                    const dateB = parseDate(b) || new Date(0);
                    return dateB - dateA; // Tri d√©croissant par d√©faut (plus r√©cent en premier)
                });
            };

            // Mise √† jour des selects de date
            const updateDateSelects = () => {
                const updateSelect = (selectElement) => {
                    const currentValue = selectElement.value;
                    selectElement.innerHTML = '<option value="">Toutes les dates</option>';
                    
                    state.availableDates.forEach(date => {
                        const option = document.createElement('option');
                        option.value = date;
                        option.textContent = date;
                        if (date === currentValue) {
                            option.selected = true;
                        }
                        selectElement.appendChild(option);
                    });
                };

                updateSelect(dateFilterSelect);
                updateSelect(dateFilterWordlistSelect);
            };

            // Filtrage des mots par date
            const filterWordsByDate = (words) => {
                if (!state.dateFilter) return words;
                return words.filter(word => word.date === state.dateFilter);
            };

            // Tri des mots par date
            const sortWordsByDate = (words) => {
                return [...words].sort((a, b) => {
                    const dateA = parseDate(a.date) || new Date(0);
                    const dateB = parseDate(b.date) || new Date(0);
                    return state.sortByDateAsc ? dateA - dateB : dateB - dateA;
                });
            };

            // Gestion des popups de traduction
            const showTranslationPopup = (element, translation) => {
                hideTranslationPopup();
                
                const popup = document.createElement('div');
                popup.className = 'translation-popup';
                popup.textContent = translation;
                
                const rect = element.getBoundingClientRect();
                popup.style.left = rect.left + (rect.width / 2) + 'px';
                popup.style.top = (rect.top - 50) + 'px';
                
                document.body.appendChild(popup);
                currentTranslationPopup = popup;
            };

            const hideTranslationPopup = () => {
                if (currentTranslationPopup) {
                    currentTranslationPopup.remove();
                    currentTranslationPopup = null;
                }
            };

            // Gestion des clics sur les mots pour afficher la traduction
            const handleWordClick = (event, word) => {
                event.stopPropagation();
                showTranslationPopup(event.target, word.french);
            };

            // Cacher la popup si on clique ailleurs
            document.addEventListener('click', hideTranslationPopup);

            // ‚å®Ô∏è NOUVELLE GESTION DES RACCOURCIS CLAVIER
            const handleKeyboard = (event) => {
                // Ignorer si on est dans un modal ou dans l'onglet liste des mots
                if (!sessionDurationModal.classList.contains('hidden') || 
                    !sheetErrorModal.classList.contains('hidden') || 
                    state.currentTab !== 'exercise') {
                    return;
                }

                switch(event.key) {
                    case 'ArrowLeft':
                        event.preventDefault();
                        goToPreviousWord();
                        break;
                    case 'ArrowRight':
                        event.preventDefault();
                        goToNextWord();
                        break;
                    case 'Enter':
                        event.preventDefault();
                        if (!checkBtn.classList.contains('hidden')) {
                            handleAnswer(answerInput.value);
                        }
                        break;
                    case 'ArrowUp':
                        event.preventDefault();
                        if (!acceptAnswerBtn.classList.contains('hidden')) {
                            handleAcceptAnswer();
                        }
                        break;
                    case ' ': // Espace pour afficher la r√©ponse
                        event.preventDefault();
                        showAnswer();
                        break;
                }
            };

            // Fonction pour afficher la r√©ponse (raccourci espace)
            const showAnswer = () => {
                if (state.currentQuestion.type !== 'qcm') {
                    // Pour les flashcards, retourner la carte
                    exerciseContainer.querySelector('.card')?.classList.add('is-flipped');
                }
                // Pour les QCM, colorer la bonne r√©ponse
                if (state.currentQuestion.type === 'qcm' && state.currentQuestion.word) {
                    const correctAnswerText = state.currentQuestion.word.french;
                    document.querySelectorAll('.qcm-option-btn').forEach(btn => {
                        if (btn.textContent === correctAnswerText) {
                            btn.className += ' bg-blue-200 border-blue-500';
                        }
                    });
                }
            };

            // Fonction pour aller au mot pr√©c√©dent
            const goToPreviousWord = () => {
                if (state.historyPosition > 0) {
                    state.historyPosition--;
                    const previousWordData = state.wordHistory[state.historyPosition];
                    state.currentWordIndex = previousWordData.wordIndex;
                    state.currentQuestion = { ...previousWordData.question };
                    renderExercise();
                    updatePrevNextButtons();
                }
            };

            // Fonction pour aller au mot suivant
            const goToNextWord = () => {
                if (state.historyPosition < state.wordHistory.length - 1) {
                    // Naviguer dans l'historique
                    state.historyPosition++;
                    const nextWordData = state.wordHistory[state.historyPosition];
                    state.currentWordIndex = nextWordData.wordIndex;
                    state.currentQuestion = { ...nextWordData.question };
                    renderExercise();
                } else {
                    // G√©n√©rer un nouveau mot
                    startNextExercise();
                }
                updatePrevNextButtons();
            };

            // Mise √† jour de la visibilit√© des boutons pr√©c√©dent/suivant
            const updatePrevNextButtons = () => {
                if (state.historyPosition > 0) {
                    prevBtn.classList.remove('hidden');
                } else {
                    prevBtn.classList.add('hidden');
                }
            };

            // Ajouter un mot √† l'historique
            const addToHistory = (wordIndex, question) => {
                // Supprimer tout l'historique apr√®s la position actuelle
                state.wordHistory = state.wordHistory.slice(0, state.historyPosition + 1);
                
                // Ajouter le nouveau mot
                state.wordHistory.push({
                    wordIndex: wordIndex,
                    question: { ...question }
                });
                
                state.historyPosition = state.wordHistory.length - 1;
                updatePrevNextButtons();
            };

            // Gestion des onglets
            const switchTab = (tabName) => {
                state.currentTab = tabName;
                
                // Mise √† jour des onglets
                if (tabName === 'exercise') {
                    tabExercise.classList.add('active');
                    tabWordlist.classList.remove('active');
                    contentExercise.classList.add('active');
                    contentWordlist.classList.remove('active');
                } else {
                    tabExercise.classList.remove('active');
                    tabWordlist.classList.add('active');
                    contentExercise.classList.remove('active');
                    contentWordlist.classList.add('active');
                    renderWordsList();
                }
            };

            tabExercise.addEventListener('click', () => switchTab('exercise'));
            tabWordlist.addEventListener('click', () => switchTab('wordlist'));

            // Gestion des filtres de date pour les exercices
            dateFilterSelect.addEventListener('change', (e) => {
                state.dateFilter = e.target.value || null;
                // Synchroniser avec l'autre select
                dateFilterWordlistSelect.value = e.target.value;
                renderWordsList();
                renderWordsTable();
                renderDashboard();
            });

            clearDateFilterBtn.addEventListener('click', () => {
                dateFilterSelect.value = '';
                dateFilterWordlistSelect.value = '';
                state.dateFilter = null;
                renderWordsList();
                renderWordsTable();
                renderDashboard();
            });

            // Gestion des filtres de date pour la liste des mots
            dateFilterWordlistSelect.addEventListener('change', (e) => {
                state.dateFilter = e.target.value || null;
                // Synchroniser avec l'autre select
                dateFilterSelect.value = e.target.value;
                renderWordsList();
                renderWordsTable();
                renderDashboard();
            });

            clearDateFilterWordlistBtn.addEventListener('click', () => {
                dateFilterSelect.value = '';
                dateFilterWordlistSelect.value = '';
                state.dateFilter = null;
                renderWordsList();
                renderWordsTable();
                renderDashboard();
            });

            sortByDateBtn.addEventListener('click', () => {
                state.sortByDateAsc = !state.sortByDateAsc;
                sortByDateBtn.textContent = state.sortByDateAsc ? 'üìÖ Trier par date ‚Üë' : 'üìÖ Trier par date ‚Üì';
                renderWordsList();
                renderWordsTable();
                renderDashboard();
            });

            // Rendu de la liste des mots avec cases √† cocher
            const renderWordsList = () => {
                wordsListContainer.innerHTML = '';
                
                if (state.words.length === 0) {
                    wordsListContainer.innerHTML = '<p class="text-gray-500 text-center">Aucun mot charg√©</p>';
                    return;
                }

                let filteredWords = filterWordsByDate(state.words);
                filteredWords = sortWordsByDate(filteredWords);

                filteredWords.forEach((word, index) => {
                    const isSelected = state.customSelection.includes(word.spanish);
                    const levelBadge = word.count >= state.learnedThreshold 
                        ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Ma√Ætris√©</span>'
                        : `<span class="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full">${word.count}/${state.learnedThreshold}</span>`;
                    
                    const wordItem = document.createElement('div');
                    wordItem.className = 'word-item flex items-center justify-between p-3 border border-gray-200 rounded-lg';
                    wordItem.innerHTML = `
                        <div class="flex items-center gap-3">
                            <input type="checkbox" 
                                   class="word-checkbox" 
                                   data-word="${word.spanish}"
                                   ${isSelected ? 'checked' : ''}>
                            <div class="flex flex-col">
                                <div>
                                    <span class="font-medium text-blue-700">${word.spanish}</span>
                                    <span class="text-gray-500 mx-2">‚Üí</span>
                                    <span class="text-gray-700">${word.french}</span>
                                </div>
                                <div class="date-badge">${word.date || 'Sans date'}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            ${levelBadge}
                            ${isSelected ? '<span class="text-yellow-500">‚≠ê</span>' : ''}
                        </div>
                    `;
                    
                    wordsListContainer.appendChild(wordItem);
                });
            };

            // Sauvegarde de la s√©lection personnalis√©e
            const saveCustomSelection = () => {
                const checkboxes = document.querySelectorAll('.word-checkbox:checked');
                state.customSelection = Array.from(checkboxes).map(cb => cb.dataset.word);
                
                localStorage.setItem('spanishAppCustomSelection', JSON.stringify(state.customSelection));
                
                // Feedback visuel
                saveCustomSelectionBtn.textContent = '‚úÖ Sauvegard√© !';
                saveCustomSelectionBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                saveCustomSelectionBtn.classList.add('bg-green-500');
                
                setTimeout(() => {
                    saveCustomSelectionBtn.textContent = 'üíæ Sauvegarder ma s√©lection';
                    saveCustomSelectionBtn.classList.remove('bg-green-500');
                    saveCustomSelectionBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                }, 2000);
                
                renderWordsList(); // Re-render pour afficher les √©toiles
            };

            saveCustomSelectionBtn.addEventListener('click', saveCustomSelection);

            // Chargement de la s√©lection personnalis√©e
            const loadCustomSelection = () => {
                const saved = localStorage.getItem('spanishAppCustomSelection');
                if (saved) {
                    state.customSelection = JSON.parse(saved);
                }
            };

            // Gestion de la session duration
            const showSessionDurationModal = () => {
                sessionDurationModal.classList.remove('hidden');
            };

            const hideSessionDurationModal = () => {
                sessionDurationModal.classList.add('hidden');
            };

            const showSheetErrorModal = () => {
                // Afficher l'URL d'exemple
                exampleUrlDisplay.textContent = GOOGLE_SHEET_URL;
                sheetErrorModal.classList.remove('hidden');
            };

            const hideSheetErrorModal = () => {
                sheetErrorModal.classList.add('hidden');
            };

            const setSessionDuration = (minutes) => {
                state.sessionDuration = minutes;
                state.sessionEndTime = Date.now() + (minutes * 60 * 1000);
                state.twoMinuteWarningShown = false;
                hideSessionDurationModal();
                startTimer();
            };

            // Event listeners pour la modal de dur√©e
            durationBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const minutes = parseInt(btn.dataset.minutes);
                    setSessionDuration(minutes);
                });
            });

            customDurationBtn.addEventListener('click', () => {
                const minutes = parseInt(customDurationInput.value);
                if (minutes && minutes > 0 && minutes <= 120) {
                    setSessionDuration(minutes);
                }
            });

            // Event listeners pour la modal d'erreur de sheet
            useExampleBtn.addEventListener('click', () => {
                newSheetUrlInput.value = GOOGLE_SHEET_URL;
            });

            validateNewSheetBtn.addEventListener('click', () => {
                const url = newSheetUrlInput.value.trim();
                if (url) {
                    hideSheetErrorModal();
                    sheetUrlInput.value = url;
                    fetchAndParseSheet(url);
                }
            });

            const startTimer = () => {
                if (!state.sessionStats.startTime) {
                    state.sessionStats.startTime = Date.now();
                }
                
                if (timerInterval) clearInterval(timerInterval);
                
                timerInterval = setInterval(() => {
                    const now = Date.now();
                    const elapsed = Math.floor((now - state.sessionStats.startTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    sessionTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    // V√©rifier l'alerte 2 minutes avant la fin
                    if (state.sessionEndTime && !state.twoMinuteWarningShown) {
                        const timeLeft = state.sessionEndTime - now;
                        const minutesLeft = Math.floor(timeLeft / (1000 * 60));
                        
                        if (minutesLeft <= 2 && minutesLeft > 0) {
                            state.twoMinuteWarningShown = true;
                            sessionTimerContainer.classList.add('warning');
                            alert(`‚è∞ Plus que ${minutesLeft} minute(s) restante(s) dans votre session !`);
                        }
                        
                        if (timeLeft <= 0) {
                            clearInterval(timerInterval);
                            alert('üéâ Session termin√©e ! Bravo pour votre travail !');
                            sessionTimerContainer.classList.add('warning');
                        }
                    }
                }, 1000);
            };

            const updateSessionStats = () => {
                sessionTotal.textContent = state.sessionStats.total;
                sessionCorrect.textContent = state.sessionStats.correct;
                sessionIncorrect.textContent = state.sessionStats.incorrect;
                sessionUnknown.textContent = state.sessionStats.unknown;
                sessionAccepted.textContent = state.sessionStats.accepted;
            };

            const resetSessionStats = () => {
                state.sessionStats = {
                    total: 0,
                    correct: 0,
                    incorrect: 0,
                    unknown: 0,
                    accepted: 0,
                    startTime: Date.now()
                };
                updateSessionStats();
                if (state.sessionEndTime) {
                    startTimer();
                }
            };

            const resetSession = () => {
                if (confirm('√ätes-vous s√ªr de vouloir recommencer la session √† z√©ro ?')) {
                    state.sessionMistakes = [];
                    state.sessionCorrect = [];
                    state.wordHistory = [];
                    state.historyPosition = -1;
                    state.twoMinuteWarningShown = false;
                    sessionTimerContainer.classList.remove('warning');
                    resetSessionStats();
                    showSessionDurationModal();
                    renderDashboard();
                    startNextExercise();
                }
            };

            const saveState = () => {
                const sheetUrl = localStorage.getItem('spanishAppSheetUrl');
                if (sheetUrl) {
                    localStorage.setItem(`spanishAppProgress_${sheetUrl}`, JSON.stringify(state.words));
                } else {
                    // Save progress for default list
                    localStorage.setItem('spanishAppProgress_default', JSON.stringify(state.words));
                }
            };

            const loadState = (sheetData) => {
                 const sheetUrl = localStorage.getItem('spanishAppSheetUrl');
                 const savedProgress = sheetUrl ? localStorage.getItem(`spanishAppProgress_${sheetUrl}`) : null;
                 if (savedProgress && !state.isFirstSession) {
                     const progress = JSON.parse(savedProgress);
                     state.words = sheetData.map(sheetWord => {
                         const matchingProgress = progress.find(p => p.spanish === sheetWord.spanish);
                         return matchingProgress || { ...sheetWord, count: 0 };
                     });
                 } else {
                     // Premi√®re session : tous les mots commencent √† 0
                     state.words = sheetData.map(word => ({ ...word, count: 0 }));
                     state.isFirstSession = false;
                 }
            };
            
            const loadDefaultWords = (errorMessage) => {
                sheetFeedback.innerHTML = `${errorMessage}<br>Chargement de la liste par d√©faut.`;
                sheetFeedback.className = 'text-xs text-center mt-2 h-auto text-orange-600 font-semibold';
                const defaultWords = [
                    { spanish: 'Hola', french: 'Bonjour', date: '2025-01-10' },
                    { spanish: 'Adi√≥s', french: 'Au revoir', date: '2025-01-10' },
                    { spanish: 'Gracias', french: 'Merci', date: '2025-01-12' },
                    { spanish: 'Por favor', french: 'S\'il vous pla√Æt', date: '2025-01-12' },
                    { spanish: 'S√≠', french: 'Oui', date: '2025-01-15' },
                    { spanish: 'No', french: 'Non', date: '2025-01-15' }
                ];
                const savedProgress = localStorage.getItem('spanishAppProgress_default');
                if(savedProgress && !state.isFirstSession) {
                    state.words = JSON.parse(savedProgress);
                } else {
                    state.words = defaultWords.map(word => ({ ...word, count: 0 }));
                    state.isFirstSession = false;
                }
                localStorage.removeItem('spanishAppSheetUrl'); // Clear invalid URL
                buildAvailableDates();
                updateDateSelects();
                saveState();
                restartApp();
            };
            
             const fetchAndParseSheet = async (url) => {
                sheetFeedback.textContent = 'Chargement...';
                sheetFeedback.className = 'text-xs text-center mt-2 h-auto text-gray-500';
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        const error = new Error(`Erreur r√©seau: ${response.statusText} (status: ${response.status})`);
                        error.status = response.status;
                        throw error;
                    }
                    const csvText = await response.text();

                    const parseCsvRow = (row) => {
                        const result = [];
                        let current = '';
                        let inQuotes = false;
                        for (const char of row) {
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                result.push(current);
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        result.push(current);
                        return result.map(field => field.replace(/^"|"$/g, '').trim());
                    };

                    const rows = csvText.trim().split('\n').slice(1);
                    const newWords = rows.map(row => {
                        if (!row) return null;
                        const columns = parseCsvRow(row);
                        if (columns.length >= 3 && columns[1] && columns[2]) {
                            return { 
                                date: columns[0] || null, // Premi√®re colonne = date (brute)
                                spanish: columns[1], 
                                french: columns[2],
                            };
                        }
                        return null;
                    }).filter(Boolean);


                    if (newWords.length > 0) {
                        localStorage.setItem('spanishAppSheetUrl', url);
                        loadState(newWords);
                        loadCustomSelection(); // Charger la s√©lection personnalis√©e
                        buildAvailableDates(); // Construire la liste des dates
                        updateDateSelects(); // Mettre √† jour les selects
                        saveState();
                        sheetFeedback.textContent = `‚úÖ ${newWords.length} mots charg√©s !`;
                        sheetFeedback.className = 'text-xs text-center mt-2 h-auto text-green-600';
                         setTimeout(() => { sheetFeedback.textContent = '' }, 3000);
                        renderWordsTable();
                        restartApp();
                    } else {
                         throw new Error("Aucun mot valide trouv√©.");
                    }
                } catch (error) {
                    console.error('Erreur de chargement du Google Sheet:', error);
                    showSheetErrorModal();
                }
            };

            const renderWordsTable = () => {
                wordsTableBody.innerHTML = '';
                
                let filteredWords = filterWordsByDate(state.words);
                filteredWords = sortWordsByDate(filteredWords);
                
                filteredWords.forEach(word => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    
                    const levelBadge = word.count >= state.learnedThreshold 
                        ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Ma√Ætris√©</span>'
                        : `<span class="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full">${word.count}/${state.learnedThreshold}</span>`;
                    
                    row.innerHTML = `
                        <td class="p-2 text-xs">${word.date || 'Sans date'}</td>
                        <td class="p-2">${word.spanish}</td>
                        <td class="p-2">${word.french}</td>
                        <td class="p-2 text-center">${levelBadge}</td>
                    `;
                    wordsTableBody.appendChild(row);
                });
            };

            const toggleWordsTable = () => {
                const isOpen = wordsTableContainer.classList.contains('open');
                if (isOpen) {
                    wordsTableContainer.classList.remove('open');
                    toggleWordsTableBtn.innerHTML = 'üëÅÔ∏è Voir';
                } else {
                    wordsTableContainer.classList.add('open');
                    toggleWordsTableBtn.innerHTML = 'üôà Cacher';
                    renderWordsTable();
                }
            };
            
            const createWordListItem = (word, colorClass, isSessionWord = false, isClickable = false) => {
                const li = document.createElement('li');
                li.className = `${isSessionWord ? '' : 'flex justify-between items-center'} ${isClickable ? 'clickable-word' : ''}`;
                
                if (isClickable) {
                    // Ajouter l'√©v√©nement de clic pour afficher la traduction
                    li.addEventListener('click', (e) => handleWordClick(e, word));
                }
                
                if (isSessionWord) {
                    // Pour les listes de session (pas de compteur)
                    li.innerHTML = `<span class="${colorClass}">${word.spanish}</span>`;
                } else {
                    // Pour les listes normales (avec compteur)
                    li.innerHTML = `<span>${word.spanish}</span><span class="text-xs font-mono ${colorClass} rounded-full px-2 py-0.5">${word.count}</span>`;
                }
                
                return li;
            };

            // Fonction utilitaire pour appliquer les filtres actifs
            const getFilteredWords = (words) => {
                let filteredWords = words;
                
                // Appliquer le filtre par date si actif
                if (state.dateFilter) {
                    filteredWords = filterWordsByDate(filteredWords);
                }
                
                // Appliquer les filtres de mode si actifs
                if (state.reviewFilter) {
                    filteredWords = filteredWords.filter(word => 
                        state.sessionMistakes.find(mistake => mistake.spanish === word.spanish)
                    );
                } else if (state.correctFilter) {
                    filteredWords = filteredWords.filter(word => 
                        state.sessionCorrect.find(correct => correct.spanish === word.spanish)
                    );
                } else if (state.customFilter) {
                    filteredWords = filteredWords.filter(word => 
                        state.customSelection.includes(word.spanish)
                    );
                }
                
                return filteredWords;
            };
            
            const renderDashboard = () => {
                wordsCorrectSessionList.innerHTML = '';
                wordsToReviewList.innerHTML = '';
                wordsToLearnList.innerHTML = '';
                wordsLearnedList.innerHTML = '';
                
                if (state.words.length === 0) {
                     wordsToLearnList.innerHTML = `<li class="text-gray-500">Chargez une liste.</li>`;
                     return;
                }

                // Mots corrects de la session (avec clics pour traduction)
                if (state.sessionCorrect.length === 0) {
                    wordsCorrectSessionList.innerHTML = `<li class="text-gray-400">Aucun mot correct pour l'instant !</li>`;
                } else {
                    state.sessionCorrect.forEach(word => {
                        wordsCorrectSessionList.appendChild(createWordListItem(word, 'text-green-600', true, true));
                    });
                }

                // Mots √† r√©viser (erreurs de la session) (avec clics pour traduction)
                if (state.sessionMistakes.length === 0) {
                    wordsToReviewList.innerHTML = `<li class="text-gray-400">Aucune erreur pour l'instant !</li>`;
                } else {
                    state.sessionMistakes.forEach(word => {
                        wordsToReviewList.appendChild(createWordListItem(word, 'text-red-600', true, true));
                    });
                }

                // Appliquer les filtres aux mots √† apprendre et aux mots ma√Ætris√©s
                const allWords = state.words;
                const filteredWords = getFilteredWords(allWords);
                
                const toLearn = filteredWords.filter(w => w.count < state.learnedThreshold);
                const learned = filteredWords.filter(w => w.count >= state.learnedThreshold);
                
                toLearn.sort((a, b) => a.count - b.count || a.spanish.localeCompare(b.spanish));
                learned.sort((a, b) => b.count - a.count || a.spanish.localeCompare(b.spanish));
                
                // Mots √† apprendre et ma√Ætris√©s (avec clics pour traduction)
                toLearn.forEach(w => wordsToLearnList.appendChild(createWordListItem(w, 'bg-orange-100 text-orange-700', false, true)));
                learned.forEach(w => wordsLearnedList.appendChild(createWordListItem(w, 'bg-green-100 text-green-700', false, true)));
                
                if(learned.length === 0) wordsLearnedList.innerHTML = `<li class="text-gray-400">Aucun mot ma√Ætris√©.</li>`;
                
                // Messages contextuels selon les filtres
                if(toLearn.length === 0 && allWords.length > 0) {
                    if (state.dateFilter || state.reviewFilter || state.correctFilter || state.customFilter) {
                        wordsToLearnList.innerHTML = `<li class="text-gray-400">Aucun mot √† apprendre avec ce filtre.</li>`;
                    } else {
                        wordsToLearnList.innerHTML = `<li class="text-gray-400">Bravo !</li>`;
                    }
                } else if (state.isFirstSession && toLearn.length === allWords.length) {
                    wordsToLearnList.innerHTML = `<li class="text-gray-400">Pr√™t √† commencer l'apprentissage ! üöÄ</li>`;
                }
            };

            const addTooltipToElement = (element, word) => {
                element.classList.add('tooltip');
                const tooltipText = state.currentQuestion.type === 'flashcard-fr-es' ? word.spanish : word.french;
                element.setAttribute('data-tooltip', tooltipText);
            };

            const renderExercise = () => {
                answerInput.value = '';
                answerInput.style.display = 'none';
                qcmOptionsContainer.innerHTML = '';
                qcmOptionsContainer.style.display = 'none';
                feedback.innerHTML = '';
                checkBtn.classList.add('hidden');
                dontKnowBtn.classList.add('hidden');
                acceptAnswerBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
                checkBtn.onclick = null;
                dontKnowBtn.onclick = null;
                acceptAnswerBtn.onclick = null;
                
                const question = state.currentQuestion;
                if (!question.word) {
                    exerciseContainer.innerHTML = `<div class="card-face bg-green-200 text-green-800 text-xl font-bold">F√©licitations ! Session termin√©e.</div>`;
                    return;
                }

                switch (question.type) {
                    case 'flashcard-es-fr':
                    case 'flashcard-fr-es':
                        renderFlashcard(question);
                        break;
                    case 'qcm':
                        renderQCM(question);
                        break;
                }
            };
            
            const renderFlashcard = (question) => {
                const [questionText, answerText] = question.type === 'flashcard-es-fr'
                    ? [question.word.spanish, question.word.french]
                    : [question.word.french, question.word.spanish];

                answerInput.style.display = 'block';
                answerInput.disabled = false;
                checkBtn.classList.remove('hidden');
                dontKnowBtn.classList.remove('hidden');
                checkBtn.onclick = () => handleAnswer(answerInput.value);
                dontKnowBtn.onclick = () => handleDontKnow();
                answerInput.focus();
                
                exerciseContainer.innerHTML = `
                    <div class="card w-full h-full">
                        <div class="card-inner">
                            <div class="card-face bg-blue-200 text-blue-800 text-2xl md:text-3xl font-bold tooltip" data-tooltip="${answerText}">${questionText}</div>
                            <div class="card-face card-back bg-purple-200 text-purple-800 text-xl md:text-2xl font-semibold">${answerText}</div>
                        </div>
                    </div>`;
            };
            
            const renderQCM = (question) => {
                // FIX: Add a guard clause to prevent rendering a broken QCM
                if (!question.options || question.options.length < 2) {
                    console.warn('renderQCM called with invalid options. Rendering flashcard instead.', question);
                    renderFlashcard({ type: 'flashcard-es-fr', word: question.word });
                    return; 
                }

                // Afficher la question dans le conteneur d'exercice avec tooltip
                const tooltipText = question.word.french;
                exerciseContainer.innerHTML = `<div class="qcm-question tooltip" data-tooltip="${tooltipText}">${question.word.spanish}</div>`;
                
                // Afficher le bouton "Je ne sais pas" pour les QCM aussi
                dontKnowBtn.classList.remove('hidden');
                dontKnowBtn.onclick = () => handleDontKnow();
                
                // Afficher les options dans la section r√©ponse
                qcmOptionsContainer.style.display = 'flex';
                question.options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.className = "w-full p-3 border bg-white rounded-lg shadow-sm hover:bg-gray-100 qcm-option-btn";
                    button.addEventListener('click', () => handleAnswer(option));
                    qcmOptionsContainer.appendChild(button);
                });
            };

            const selectNextWord = () => {
                let wordsPool = getFilteredWords(state.words);
                
                // Mode normal: tous les mots non ma√Ætris√©s (avec filtres appliqu√©s)
                wordsPool = wordsPool
                    .map((word, originalIndex) => ({ 
                        ...word, 
                        originalIndex: state.words.findIndex(w => w.spanish === word.spanish)
                    }))
                    .filter(word => word.count < state.learnedThreshold);
                
                if (wordsPool.length === 0) {
                    state.currentWordIndex = null;
                    return;
                }
                
                wordsPool.sort((a,b) => a.count - b.count);
                const minCount = wordsPool[0].count;
                const leastSeenWords = wordsPool.filter(word => word.count === minCount);
                const randomIndex = Math.floor(Math.random() * leastSeenWords.length);
                state.currentWordIndex = leastSeenWords[randomIndex].originalIndex;
            };

            const startNextExercise = () => {
                selectNextWord();
                if (state.currentWordIndex === null) {
                    state.currentQuestion = {};
                    renderExercise();
                    return;
                }

                let exerciseType = state.exerciseMode;
                if (exerciseType === 'mix') {
                    const types = ['flashcard-es-fr', 'flashcard-fr-es', 'qcm'];
                    exerciseType = types[Math.floor(Math.random() * types.length)];
                }
                
                state.currentQuestion = { type: exerciseType, word: state.words[state.currentWordIndex] };

                if (exerciseType === 'qcm') {
                    try {
                        const correctWord = state.currentQuestion.word;
                        if (state.words.length < 4) throw new Error("Pas assez de mots pour un QCM.");
                        
                        const distractors = [];
                        const wordPool = state.words.filter(w => w.spanish !== correctWord.spanish && w.french);

                        while (distractors.length < 3 && wordPool.length > 0) {
                            const randIdx = Math.floor(Math.random() * wordPool.length);
                            distractors.push(wordPool.splice(randIdx, 1)[0]);
                        }
                        
                        if (!correctWord || !correctWord.french) throw new Error("Mot actuel invalide.");
                        
                        const options = [correctWord, ...distractors].map(w => w.french);
                        if (options.length < 4) throw new Error("Pas assez d'options pour un QCM.");
                        
                        state.currentQuestion.options = options.sort(() => Math.random() - 0.5);

                    } catch (error) {
                        console.warn(`Impossible de cr√©er un QCM, bascule vers Flashcard: ${error.message}`);
                        state.currentQuestion.type = 'flashcard-es-fr';
                    }
                }
                
                // Ajouter √† l'historique seulement pour les nouveaux mots
                addToHistory(state.currentWordIndex, state.currentQuestion);
                
                renderExercise();
            };
            
            const normalizeUserAnswer = (answer) => answer.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[.,!?¬ø]/g, '').trim().replace(/\s+/g, ' ');

            const getPossibleAnswers = (frenchAnswer) => {
                let base = frenchAnswer.toLowerCase().trim();
                let alternatives = base.split(/\s*\/\s*/);
                let finalAnswers = [];
                alternatives.forEach(alt => {
                    const match = alt.match(/(.*)\((.+)\)$/); 
                    if (match) {
                        finalAnswers.push(match[1].trim());
                        finalAnswers.push(match[1].trim() + match[2]);
                    } else {
                        finalAnswers.push(alt.trim());
                    }
                });
                return finalAnswers.map(ans => normalizeUserAnswer(ans));
            };

            const getQuestionText = () => {
                const { type, word } = state.currentQuestion;
                if (type === 'qcm' || type === 'flashcard-es-fr') {
                    return word.spanish;
                } else if (type === 'flashcard-fr-es') {
                    return word.french;
                }
                return '';
            };

            const handleAcceptAnswer = () => {
                const { word } = state.currentQuestion;
                
                // Compter comme correct
                word.count++;
                state.sessionStats.accepted++;
                state.sessionStats.total++;
                
                // Ajouter aux mots corrects si pas d√©j√† pr√©sent
                if (!state.sessionCorrect.find(w => w.spanish === word.spanish)) {
                    state.sessionCorrect.push({ ...word });
                }
                
                // Retirer des erreurs de session si pr√©sent
                state.sessionMistakes = state.sessionMistakes.filter(w => w.spanish !== word.spanish);
                
                // V√©rifier si le mot est maintenant ma√Ætris√©
                if (word.count >= state.learnedThreshold) {
                    // Le mot sera automatiquement dans la section "ma√Ætris√©" lors du prochain renderDashboard()
                }
                
                updateSessionStats();
                saveState();
                renderDashboard();
                
                // Masquer les boutons et pr√©parer le suivant
                acceptAnswerBtn.classList.add('hidden');
                nextBtn.classList.remove('hidden');
                nextBtn.focus();
                
                feedback.innerHTML = `
                    <div class="feedback-box border-green-500 bg-green-50">
                        <div class="text-sm text-gray-700 mb-2">
                            <strong>Question :</strong> ${getQuestionText()}
                        </div>
                        <div class="text-green-600 font-bold">‚úÖ R√©ponse accept√©e ! üëç</div>
                    </div>
                `;
            };

            const handleDontKnow = () => {
                const { word } = state.currentQuestion;
                
                // Marquer comme incorrect
                word.count = 0;
                state.sessionStats.unknown++;
                state.sessionStats.total++;
                
                // Ajouter aux mots √† r√©viser si pas d√©j√† pr√©sent
                if (!state.sessionMistakes.find(w => w.spanish === word.spanish)) {
                    state.sessionMistakes.push({ ...word });
                }
                
                // Afficher la r√©ponse avec question
                const correctAnswerText = state.currentQuestion.type === 'flashcard-fr-es' ? word.spanish : word.french;
                feedback.innerHTML = `
                    <div class="feedback-box border-orange-500 bg-orange-50">
                        <div class="text-sm text-gray-700 mb-2">
                            <strong>Question :</strong> ${getQuestionText()}
                        </div>
                        <div class="text-orange-600 font-bold">ü§∑ La r√©ponse √©tait : <strong class="text-blue-600">${correctAnswerText}</strong></div>
                    </div>
                `;
                
                // D√©sactiver les contr√¥les
                answerInput.disabled = true;
                checkBtn.classList.add('hidden');
                dontKnowBtn.classList.add('hidden');
                document.querySelectorAll('.qcm-option-btn').forEach(btn => btn.disabled = true);
                
                // Montrer la carte retourn√©e pour les flashcards
                if (state.currentQuestion.type !== 'qcm') {
                    exerciseContainer.querySelector('.card')?.classList.add('is-flipped');
                }
                
                // Colorer les options QCM
                if (state.currentQuestion.type === 'qcm') {
                    document.querySelectorAll('.qcm-option-btn').forEach(btn => {
                        if (btn.textContent === correctAnswerText) {
                            btn.className += ' bg-blue-200 border-blue-500';
                        }
                    });
                }
                
                updateSessionStats();
                nextBtn.classList.remove('hidden');
                nextBtn.focus();
                saveState();
                renderDashboard();
            };

            const handleAnswer = (userAnswer) => {
                state.lastUserAnswer = userAnswer;
                answerInput.disabled = true;
                checkBtn.classList.add('hidden');
                dontKnowBtn.classList.add('hidden');
                checkBtn.onclick = null;
                dontKnowBtn.onclick = null;
                document.querySelectorAll('.qcm-option-btn').forEach(btn => btn.disabled = true);

                const { type, word } = state.currentQuestion;
                let isCorrect = false;
                let correctAnswerText = '';

                if (type === 'flashcard-es-fr' || type === 'qcm') {
                    correctAnswerText = word.french;
                    const possibleCorrect = getPossibleAnswers(correctAnswerText);
                    isCorrect = possibleCorrect.includes(normalizeUserAnswer(userAnswer));
                } else if (type === 'flashcard-fr-es') {
                    correctAnswerText = word.spanish;
                    isCorrect = normalizeUserAnswer(userAnswer) === normalizeUserAnswer(correctAnswerText);
                }

                state.sessionStats.total++;

                if (isCorrect) {
                    word.count++;
                    state.sessionStats.correct++;
                    
                    // Ajouter aux mots corrects si pas d√©j√† pr√©sent
                    if (!state.sessionCorrect.find(w => w.spanish === word.spanish)) {
                        state.sessionCorrect.push({ ...word });
                    }
                    
                    // Retirer des erreurs de session si pr√©sent
                    state.sessionMistakes = state.sessionMistakes.filter(w => w.spanish !== word.spanish);
                    
                    feedback.innerHTML = `
                        <div class="feedback-box border-green-500 bg-green-50">
                            <div class="text-sm text-gray-700 mb-2">
                                <strong>Question :</strong> ${getQuestionText()}
                            </div>
                            <div class="text-sm text-gray-700 mb-2">
                                <strong>Votre r√©ponse :</strong> ${userAnswer}
                            </div>
                            <div class="text-green-600 font-bold">‚úÖ Correct ! üëç</div>
                        </div>
                    `;
                    nextBtn.classList.remove('hidden');
                    nextBtn.focus();
                    
                } else {
                    word.count = 0;
                    state.sessionStats.incorrect++;
                    // Ajouter aux mots √† r√©viser si pas d√©j√† pr√©sent
                    if (!state.sessionMistakes.find(w => w.spanish === word.spanish)) {
                        state.sessionMistakes.push({ ...word });
                    }
                    feedback.innerHTML = `
                        <div class="feedback-box border-red-500 bg-red-50">
                            <div class="text-sm text-gray-700 mb-2">
                                <strong>Question :</strong> ${getQuestionText()}
                            </div>
                            <div class="text-sm text-gray-700 mb-2">
                                <strong>Votre r√©ponse :</strong> ${userAnswer}
                            </div>
                            <div class="text-red-600 font-bold">‚ùå Incorrect. La r√©ponse √©tait : <strong class="text-blue-600">${correctAnswerText}</strong></div>
                        </div>
                    `;
                    
                    // Montrer le bouton "Accepter ma r√©ponse"
                    acceptAnswerBtn.classList.remove('hidden');
                    acceptAnswerBtn.onclick = handleAcceptAnswer;
                    nextBtn.classList.remove('hidden');
                    
                    // Montrer la carte retourn√©e pour les flashcards UNIQUEMENT si incorrecte
                    if (type !== 'qcm') {
                        exerciseContainer.querySelector('.card')?.classList.add('is-flipped');
                    }
                }
                
                if (type === 'qcm') {
                    document.querySelectorAll('.qcm-option-btn').forEach(btn => {
                        if (btn.textContent === correctAnswerText) btn.className += ' bg-green-200 border-green-500';
                        else if (btn.textContent === userAnswer && !isCorrect) btn.className += ' bg-red-200 border-red-500';
                    });
                }
                
                updateSessionStats();
                saveState();
                renderDashboard();
            };
            
            const restartApp = () => {
                state.sessionMistakes = []; // Reset des erreurs de session
                state.sessionCorrect = []; // Reset des mots corrects de session
                state.wordHistory = []; // Reset de l'historique
                state.historyPosition = -1;
                resetSessionStats(); // Reset des statistiques
                renderDashboard();
                startNextExercise();
            };

            const init = async () => {
                // Utilisation de la constante centralis√©e
                sheetUrlInput.value = GOOGLE_SHEET_URL;
                
                document.querySelector(`[data-mode="${state.exerciseMode}"]`).classList.add('active');
                
                // Charger la s√©lection personnalis√©e
                loadCustomSelection();
                
                // Demander la dur√©e de session au lancement
                showSessionDurationModal();
                
                await fetchAndParseSheet(GOOGLE_SHEET_URL);
            };
            
            // Event listeners pour les boutons
            nextBtn.addEventListener('click', goToNextWord);
            prevBtn.addEventListener('click', goToPreviousWord);
            loadSheetBtn.addEventListener('click', () => { if (sheetUrlInput.value.trim()) fetchAndParseSheet(sheetUrlInput.value.trim()); });
            resetSessionBtn.addEventListener('click', resetSession);
            toggleWordsTableBtn.addEventListener('click', toggleWordsTable);
            
            // Gestionnaire du filtre de r√©vision
            reviewFilterBtn.addEventListener('click', () => {
                state.reviewFilter = !state.reviewFilter;
                if (state.reviewFilter) {
                    state.correctFilter = false; // D√©sactiver les autres filtres
                    state.customFilter = false;
                    correctFilterBtn.classList.remove('active-correct');
                    customFilterBtn.classList.remove('active-review');
                    correctFilterBtn.textContent = '‚úÖ R√©viser uniquement les mots corrects';
                    customFilterBtn.textContent = '‚≠ê R√©viser uniquement mes mots choisis';
                    
                    reviewFilterBtn.classList.add('active-review');
                    reviewFilterBtn.textContent = 'üéØ Mode r√©vision activ√©';
                } else {
                    reviewFilterBtn.classList.remove('active-review');
                    reviewFilterBtn.textContent = 'üéØ R√©viser uniquement les mots √† r√©viser';
                }
                renderDashboard(); // Mettre √† jour l'affichage
                startNextExercise(); // Red√©marrer avec le nouveau filtre
            });

            // Gestionnaire du filtre des mots corrects
            correctFilterBtn.addEventListener('click', () => {
                state.correctFilter = !state.correctFilter;
                if (state.correctFilter) {
                    state.reviewFilter = false; // D√©sactiver les autres filtres
                    state.customFilter = false;
                    reviewFilterBtn.classList.remove('active-review');
                    customFilterBtn.classList.remove('active-review');
                    reviewFilterBtn.textContent = 'üéØ R√©viser uniquement les mots √† r√©viser';
                    customFilterBtn.textContent = '‚≠ê R√©viser uniquement mes mots choisis';
                    
                    correctFilterBtn.classList.add('active-correct');
                    correctFilterBtn.textContent = '‚úÖ Mode mots corrects activ√©';
                } else {
                    correctFilterBtn.classList.remove('active-correct');
                    correctFilterBtn.textContent = '‚úÖ R√©viser uniquement les mots corrects';
                }
                renderDashboard(); // Mettre √† jour l'affichage
                startNextExercise(); // Red√©marrer avec le nouveau filtre
            });

            // Gestionnaire du filtre personnalis√©
            customFilterBtn.addEventListener('click', () => {
                state.customFilter = !state.customFilter;
                if (state.customFilter) {
                    state.reviewFilter = false; // D√©sactiver les autres filtres
                    state.correctFilter = false;
                    reviewFilterBtn.classList.remove('active-review');
                    correctFilterBtn.classList.remove('active-correct');
                    reviewFilterBtn.textContent = 'üéØ R√©viser uniquement les mots √† r√©viser';
                    correctFilterBtn.textContent = '‚úÖ R√©viser uniquement les mots corrects';
                    
                    customFilterBtn.classList.add('active-review');
                    customFilterBtn.textContent = '‚≠ê Mode mots choisis activ√©';
                } else {
                    customFilterBtn.classList.remove('active-review');
                    customFilterBtn.textContent = '‚≠ê R√©viser uniquement mes mots choisis';
                }
                renderDashboard(); // Mettre √† jour l'affichage
                startNextExercise(); // Red√©marrer avec le nouveau filtre
            });
            
            modeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    state.exerciseMode = button.dataset.mode;
                    modeButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    restartApp();
                });
            });

            // ‚å®Ô∏è AJOUT DU GESTIONNAIRE DE CLAVIER
            document.addEventListener('keydown', handleKeyboard);
            
            init();
        });
    </script>
</body>
</html>
