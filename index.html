<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©vision des mots de vocabulaire de Cl√©mence LOPEZ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card { perspective: 1000px; }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.is-flipped .card-inner { transform: rotateY(180deg); }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            text-align: center;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .card-back { transform: rotateY(180deg); }
        .mode-btn {
            border: 1px solid #d1d5db;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            background-color: white;
        }
        .mode-btn.active {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
            border-color: #3b82f6;
        }
        .qcm-option-btn {
            transition: all 0.2s;
            border: 1px solid #d1d5db;
        }
        .qcm-question {
            background-color: #dbeafe;
            color: #1e40af;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            margin-bottom: 1.5rem;
        }
        .tooltip {
            position: relative;
            cursor: pointer;
        }
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 10;
            margin-bottom: 0.25rem;
            pointer-events: none;
        }
        .tooltip:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: #1f2937;
            z-index: 10;
            pointer-events: none;
        }
        .feedback-box {
            background-color: #f3f4f6;
            border: 2px solid #d1d5db;
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 1rem 0;
        }
        .timer {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .filter-btn {
            border: 1px solid #d1d5db;
            padding: 0.4rem 0.8rem;
            border-radius: 0.4rem;
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.2s;
            background-color: white;
        }
        .filter-btn.active-review {
            background-color: #dc2626;
            color: white;
            border-color: #dc2626;
        }
        .filter-btn.active-correct {
            background-color: #16a34a;
            color: white;
            border-color: #16a34a;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 sm:p-6 md:p-8 min-h-screen flex flex-col">

    <div id="app" class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8 flex-grow">
        
        <main class="lg:col-span-2 space-y-6">
            <header class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-blue-600">R√©vision des mots de vocabulaire de Cl√©mence LOPEZ</h1>
                <div class="mt-2 flex justify-center items-center gap-4">
                    <div class="timer text-blue-600">‚è±Ô∏è <span id="session-timer">00:00</span></div>
                </div>
            </header>
            
            <div id="exercise-mode-selection" class="flex justify-center gap-2 sm:gap-4 flex-wrap">
                <button data-mode="mix" class="mode-btn">üöÄ Mix</button>
                <button data-mode="flashcard-es-fr" class="mode-btn">üá™üá∏ ‚Üí üá´üá∑ Flashcard</button>
                <button data-mode="flashcard-fr-es" class="mode-btn">üá´üá∑ ‚Üí üá™üá∏ Flashcard</button>
                <button data-mode="qcm" class="mode-btn">üß† QCM</button>
            </div>

            <div class="flex justify-center gap-2 flex-wrap">
                <button id="review-filter-btn" class="filter-btn">üéØ R√©viser uniquement les mots √† r√©viser</button>
                <button id="correct-filter-btn" class="filter-btn">‚úÖ R√©viser uniquement les mots corrects</button>
            </div>
            
            <div id="exercise-container" class="h-64 sm:h-72">
                <!-- L'exercice (carte ou QCM) sera inject√© ici -->
            </div>
            
            <div id="answer-section" class="mt-4 space-y-3 min-h-[120px]">
                <input type="text" id="answer-input" placeholder="√âcrivez la traduction ici..." autocomplete="off" class="w-full max-w-md mx-auto block p-3 border border-gray-300 rounded-lg text-center text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                <div id="qcm-options" class="flex flex-col items-center gap-3 w-full max-w-md mx-auto"></div>
                <div id="feedback" class="text-center min-h-[60px] font-semibold pt-2"></div>
            </div>

            <div id="controls" class="flex justify-center gap-4 flex-wrap">
                 <button id="check-btn" class="bg-blue-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-600 transition-transform transform hover:scale-105">
                    V√©rifier
                </button>
                <button id="dont-know-btn" class="bg-orange-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-orange-600 transition-transform transform hover:scale-105">
                    Je ne sais pas
                </button>
                <button id="accept-answer-btn" class="hidden bg-green-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-600 transition-transform transform hover:scale-105">
                    Accepter ma r√©ponse
                </button>
                <button id="next-btn" class="hidden bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-800 transition-transform transform hover:scale-105">
                    Mot Suivant ‚û°Ô∏è
                </button>
            </div>
        </main>

        <aside class="space-y-8">
            <div>
                <h2 class="text-2xl font-semibold mb-4 text-blue-600">Tableau de Bord</h2>
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-xl shadow">
                        <h3 class="font-bold mb-2 text-purple-500">üìä Session en cours</h3>
                        <div class="text-sm space-y-1">
                            <div class="flex justify-between">
                                <span>Mots r√©vis√©s :</span>
                                <span id="session-total" class="font-mono font-bold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>‚úÖ Correctes :</span>
                                <span id="session-correct" class="font-mono font-bold text-green-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>‚ùå Incorrectes :</span>
                                <span id="session-incorrect" class="font-mono font-bold text-red-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>ü§∑ Je ne sais pas :</span>
                                <span id="session-unknown" class="font-mono font-bold text-orange-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>üìà Accept√©es :</span>
                                <span id="session-accepted" class="font-mono font-bold text-blue-600">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow">
                        <h3 class="font-bold mb-2 text-green-500">‚úÖ Mots corrects (session)</h3>
                        <ul id="words-correct-session" class="space-y-2 text-sm max-h-48 overflow-y-auto pr-2"></ul>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow">
                        <h3 class="font-bold mb-2 text-red-500">‚ùå Mots √† r√©viser (session)</h3>
                        <ul id="words-to-review" class="space-y-2 text-sm max-h-48 overflow-y-auto pr-2"></ul>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow">
                        <h3 class="font-bold mb-2 text-orange-500">üß† Mots √† apprendre</h3>
                        <ul id="words-to-learn" class="space-y-2 text-sm max-h-48 overflow-y-auto pr-2"></ul>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow">
                        <h3 class="font-bold mb-2 text-green-500">üèÜ Mots ma√Ætris√©s</h3>
                        <ul id="words-learned" class="space-y-2 text-sm max-h-48 overflow-y-auto pr-2"></ul>
                    </div>
                </div>
            </div>

            <div>
                <h2 class="text-2xl font-semibold mb-4 text-blue-600">Lien Google Sheet</h2>
                 <div class="bg-white p-4 rounded-xl shadow">
                    <p class="text-sm text-gray-600 mb-2">
                        Publiez votre Google Sheet sur le web (format CSV) et collez le lien ici.
                    </p>
                    <input type="url" id="sheet-url-input" placeholder="https://docs.google.com/..." class="w-full border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    <button id="load-sheet-btn" class="mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md">
                        Charger la liste
                    </button>
                    <p id="sheet-feedback" class="text-xs text-center mt-2 h-auto"></p>
                 </div>
            </div>
        </aside>
    </div>

    <!-- Pied de page -->
    <footer class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-500">
        <p>Version 2.1 | D√©velopp√© par <strong>David LOPEZ</strong> | √âcole <strong>IMAC</strong></p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const state = {
                words: [],
                currentWordIndex: null,
                learnedThreshold: 3,
                exerciseMode: 'mix', // 'mix', 'flashcard-es-fr', 'flashcard-fr-es', 'qcm'
                currentQuestion: {}, // { type, word, options, answer }
                sessionMistakes: [], // Mots rat√©s pendant cette session
                sessionCorrect: [], // Mots corrects pendant cette session
                sessionStats: {
                    total: 0,
                    correct: 0,
                    incorrect: 0,
                    unknown: 0,
                    accepted: 0,
                    startTime: null
                },
                lastUserAnswer: '', // Pour pouvoir l'afficher dans le feedback
                reviewFilter: false, // Filtre pour ne r√©viser que les mots √† r√©viser
                correctFilter: false, // Filtre pour ne r√©viser que les mots corrects
            };

            const exerciseContainer = document.getElementById('exercise-container');
            const wordsCorrectSessionList = document.getElementById('words-correct-session');
            const wordsToReviewList = document.getElementById('words-to-review');
            const wordsToLearnList = document.getElementById('words-to-learn');
            const wordsLearnedList = document.getElementById('words-learned');
            const sheetUrlInput = document.getElementById('sheet-url-input');
            const loadSheetBtn = document.getElementById('load-sheet-btn');
            const sheetFeedback = document.getElementById('sheet-feedback');
            const answerInput = document.getElementById('answer-input');
            const qcmOptionsContainer = document.getElementById('qcm-options');
            const feedback = document.getElementById('feedback');
            const checkBtn = document.getElementById('check-btn');
            const dontKnowBtn = document.getElementById('dont-know-btn');
            const acceptAnswerBtn = document.getElementById('accept-answer-btn');
            const nextBtn = document.getElementById('next-btn');
            const modeButtons = document.querySelectorAll('.mode-btn');
            const sessionTimer = document.getElementById('session-timer');
            const reviewFilterBtn = document.getElementById('review-filter-btn');
            const correctFilterBtn = document.getElementById('correct-filter-btn');

            // √âl√©ments des statistiques de session
            const sessionTotal = document.getElementById('session-total');
            const sessionCorrect = document.getElementById('session-correct');
            const sessionIncorrect = document.getElementById('session-incorrect');
            const sessionUnknown = document.getElementById('session-unknown');
            const sessionAccepted = document.getElementById('session-accepted');

            let timerInterval = null;

            const startTimer = () => {
                if (!state.sessionStats.startTime) {
                    state.sessionStats.startTime = Date.now();
                }
                
                if (timerInterval) clearInterval(timerInterval);
                
                timerInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - state.sessionStats.startTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    sessionTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            };

            const updateSessionStats = () => {
                sessionTotal.textContent = state.sessionStats.total;
                sessionCorrect.textContent = state.sessionStats.correct;
                sessionIncorrect.textContent = state.sessionStats.incorrect;
                sessionUnknown.textContent = state.sessionStats.unknown;
                sessionAccepted.textContent = state.sessionStats.accepted;
            };

            const resetSessionStats = () => {
                state.sessionStats = {
                    total: 0,
                    correct: 0,
                    incorrect: 0,
                    unknown: 0,
                    accepted: 0,
                    startTime: Date.now()
                };
                updateSessionStats();
                startTimer();
            };

            const saveState = () => {
                const sheetUrl = localStorage.getItem('spanishAppSheetUrl');
                if (sheetUrl) {
                    localStorage.setItem(`spanishAppProgress_${sheetUrl}`, JSON.stringify(state.words));
                } else {
                    // Save progress for default list
                    localStorage.setItem('spanishAppProgress_default', JSON.stringify(state.words));
                }
            };

            const loadState = (sheetData) => {
                 const sheetUrl = localStorage.getItem('spanishAppSheetUrl');
                 const savedProgress = sheetUrl ? localStorage.getItem(`spanishAppProgress_${sheetUrl}`) : null;
                 if (savedProgress) {
                     const progress = JSON.parse(savedProgress);
                     state.words = sheetData.map(sheetWord => {
                         const matchingProgress = progress.find(p => p.spanish === sheetWord.spanish);
                         return matchingProgress || { ...sheetWord, count: 0 };
                     });
                 } else {
                     state.words = sheetData.map(word => ({ ...word, count: 0 }));
                 }
            };
            
            const loadDefaultWords = (errorMessage) => {
                sheetFeedback.innerHTML = `${errorMessage}<br>Chargement de la liste par d√©faut.`;
                sheetFeedback.className = 'text-xs text-center mt-2 h-auto text-orange-600 font-semibold';
                const defaultWords = [
                    { spanish: 'Hola', french: 'Bonjour' },
                    { spanish: 'Adi√≥s', french: 'Au revoir' },
                    { spanish: 'Gracias', french: 'Merci' },
                    { spanish: 'Por favor', french: 'S\'il vous pla√Æt' },
                    { spanish: 'S√≠', french: 'Oui' },
                    { spanish: 'No', french: 'Non' }
                ];
                const savedProgress = localStorage.getItem('spanishAppProgress_default');
                if(savedProgress) {
                    state.words = JSON.parse(savedProgress);
                } else {
                    state.words = defaultWords.map(word => ({ ...word, count: 0 }));
                }
                localStorage.removeItem('spanishAppSheetUrl'); // Clear invalid URL
                saveState();
                restartApp();
            };
            
             const fetchAndParseSheet = async (url) => {
                sheetFeedback.textContent = 'Chargement...';
                sheetFeedback.className = 'text-xs text-center mt-2 h-auto text-gray-500';
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        const error = new Error(`Erreur r√©seau: ${response.statusText} (status: ${response.status})`);
                        error.status = response.status;
                        throw error;
                    }
                    const csvText = await response.text();

                    const parseCsvRow = (row) => {
                        const result = [];
                        let current = '';
                        let inQuotes = false;
                        for (const char of row) {
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                result.push(current);
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        result.push(current);
                        return result.map(field => field.replace(/^"|"$/g, '').trim());
                    };

                    const rows = csvText.trim().split('\n').slice(1);
                    const newWords = rows.map(row => {
                        if (!row) return null;
                        const columns = parseCsvRow(row);
                        if (columns.length >= 3 && columns[1] && columns[2]) {
                            return { 
                                spanish: columns[1], 
                                french: columns[2],
                            };
                        }
                        return null;
                    }).filter(Boolean);


                    if (newWords.length > 0) {
                        localStorage.setItem('spanishAppSheetUrl', url);
                        loadState(newWords);
                        saveState();
                        sheetFeedback.textContent = `‚úÖ ${newWords.length} mots charg√©s !`;
                        sheetFeedback.className = 'text-xs text-center mt-2 h-auto text-green-600';
                         setTimeout(() => { sheetFeedback.textContent = '' }, 3000);
                        restartApp();
                    } else {
                         throw new Error("Aucun mot valide trouv√©.");
                    }
                } catch (error) {
                    console.error('Erreur de chargement du Google Sheet:', error);
                    let errorMessage = '‚ùå Erreur. V√©rifiez le lien.';
                    if (error.status === 404) {
                        errorMessage = '‚ùå Lien introuvable (404). La feuille est-elle bien "Publi√©e sur le web" ?';
                    } else if (error.message.includes('Failed to fetch')) {
                        errorMessage = '‚ùå Erreur r√©seau. V√©rifiez votre connexion internet.';
                    }
                    loadDefaultWords(errorMessage);
                }
            };
            
            const createWordListItem = (word, colorClass, isSessionWord = false) => {
                const li = document.createElement('li');
                li.className = `tooltip ${isSessionWord ? '' : 'flex justify-between items-center'}`;
                li.setAttribute('data-tooltip', word.french);
                
                if (isSessionWord) {
                    // Pour les listes de session (pas de compteur)
                    li.innerHTML = `<span class="${colorClass}">${word.spanish}</span>`;
                } else {
                    // Pour les listes normales (avec compteur)
                    li.innerHTML = `<span>${word.spanish}</span><span class="text-xs font-mono ${colorClass} rounded-full px-2 py-0.5">${word.count}</span>`;
                }
                
                return li;
            };
            
            const renderDashboard = () => {
                wordsCorrectSessionList.innerHTML = '';
                wordsToReviewList.innerHTML = '';
                wordsToLearnList.innerHTML = '';
                wordsLearnedList.innerHTML = '';
                
                if (state.words.length === 0) {
                     wordsToLearnList.innerHTML = `<li class="text-gray-500">Chargez une liste.</li>`;
                     return;
                }

                // Mots corrects de la session
                if (state.sessionCorrect.length === 0) {
                    wordsCorrectSessionList.innerHTML = `<li class="text-gray-400">Aucun mot correct pour l'instant !</li>`;
                } else {
                    state.sessionCorrect.forEach(word => {
                        wordsCorrectSessionList.appendChild(createWordListItem(word, 'text-green-600', true));
                    });
                }

                // Mots √† r√©viser (erreurs de la session)
                if (state.sessionMistakes.length === 0) {
                    wordsToReviewList.innerHTML = `<li class="text-gray-400">Aucune erreur pour l'instant !</li>`;
                } else {
                    state.sessionMistakes.forEach(word => {
                        wordsToReviewList.appendChild(createWordListItem(word, 'text-red-600', true));
                    });
                }

                const toLearn = state.words.filter(w => w.count < state.learnedThreshold);
                const learned = state.words.filter(w => w.count >= state.learnedThreshold);
                toLearn.sort((a, b) => a.count - b.count || a.spanish.localeCompare(b.spanish));
                learned.sort((a, b) => b.count - a.count || a.spanish.localeCompare(b.spanish));
                
                toLearn.forEach(w => wordsToLearnList.appendChild(createWordListItem(w, 'bg-orange-100 text-orange-700', false)));
                learned.forEach(w => wordsLearnedList.appendChild(createWordListItem(w, 'bg-green-100 text-green-700', false)));
                
                if(learned.length === 0) wordsLearnedList.innerHTML = `<li class="text-gray-400">Aucun mot ma√Ætris√©.</li>`;
                if(toLearn.length === 0 && state.words.length > 0) wordsToLearnList.innerHTML = `<li class="text-gray-400">Bravo !</li>`;
            };

            const addTooltipToElement = (element, word) => {
                element.classList.add('tooltip');
                const tooltipText = state.currentQuestion.type === 'flashcard-fr-es' ? word.spanish : word.french;
                element.setAttribute('data-tooltip', tooltipText);
            };

            const renderExercise = () => {
                answerInput.value = '';
                answerInput.style.display = 'none';
                qcmOptionsContainer.innerHTML = '';
                qcmOptionsContainer.style.display = 'none';
                feedback.innerHTML = '';
                checkBtn.classList.add('hidden');
                dontKnowBtn.classList.add('hidden');
                acceptAnswerBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
                checkBtn.onclick = null;
                dontKnowBtn.onclick = null;
                acceptAnswerBtn.onclick = null;
                
                const question = state.currentQuestion;
                if (!question.word) {
                    exerciseContainer.innerHTML = `<div class="card-face bg-green-200 text-green-800 text-xl font-bold">F√©licitations ! Session termin√©e.</div>`;
                    return;
                }

                switch (question.type) {
                    case 'flashcard-es-fr':
                    case 'flashcard-fr-es':
                        renderFlashcard(question);
                        break;
                    case 'qcm':
                        renderQCM(question);
                        break;
                }
            };
            
            const renderFlashcard = (question) => {
                const [questionText, answerText] = question.type === 'flashcard-es-fr'
                    ? [question.word.spanish, question.word.french]
                    : [question.word.french, question.word.spanish];

                answerInput.style.display = 'block';
                answerInput.disabled = false;
                checkBtn.classList.remove('hidden');
                dontKnowBtn.classList.remove('hidden');
                checkBtn.onclick = () => handleAnswer(answerInput.value);
                dontKnowBtn.onclick = () => handleDontKnow();
                answerInput.focus();
                
                exerciseContainer.innerHTML = `
                    <div class="card w-full h-full">
                        <div class="card-inner">
                            <div class="card-face bg-blue-200 text-blue-800 text-2xl md:text-3xl font-bold tooltip" data-tooltip="${answerText}">${questionText}</div>
                            <div class="card-face card-back bg-purple-200 text-purple-800 text-xl md:text-2xl font-semibold">${answerText}</div>
                        </div>
                    </div>`;
            };
            
            const renderQCM = (question) => {
                // FIX: Add a guard clause to prevent rendering a broken QCM
                if (!question.options || question.options.length < 2) {
                    console.warn('renderQCM called with invalid options. Rendering flashcard instead.', question);
                    renderFlashcard({ type: 'flashcard-es-fr', word: question.word });
                    return; 
                }

                // Afficher la question dans le conteneur d'exercice avec tooltip
                const tooltipText = question.word.french;
                exerciseContainer.innerHTML = `<div class="qcm-question tooltip" data-tooltip="${tooltipText}">${question.word.spanish}</div>`;
                
                // Afficher le bouton "Je ne sais pas" pour les QCM aussi
                dontKnowBtn.classList.remove('hidden');
                dontKnowBtn.onclick = () => handleDontKnow();
                
                // Afficher les options dans la section r√©ponse
                qcmOptionsContainer.style.display = 'flex';
                question.options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.className = "w-full p-3 border bg-white rounded-lg shadow-sm hover:bg-gray-100 qcm-option-btn";
                    button.addEventListener('click', () => handleAnswer(option));
                    qcmOptionsContainer.appendChild(button);
                });
            };

            const selectNextWord = () => {
                let wordsPool = [];
                
                if (state.reviewFilter && state.sessionMistakes.length > 0) {
                    // Mode r√©vision: ne prendre que les mots en erreur de la session
                    wordsPool = state.words
                        .map((word, index) => ({ ...word, originalIndex: index }))
                        .filter(word => state.sessionMistakes.find(mistake => mistake.spanish === word.spanish));
                } else if (state.correctFilter && state.sessionCorrect.length > 0) {
                    // Mode r√©vision des mots corrects: ne prendre que les mots corrects de la session
                    wordsPool = state.words
                        .map((word, index) => ({ ...word, originalIndex: index }))
                        .filter(word => state.sessionCorrect.find(correct => correct.spanish === word.spanish));
                } else {
                    // Mode normal: tous les mots non ma√Ætris√©s
                    wordsPool = state.words
                        .map((word, index) => ({ ...word, originalIndex: index }))
                        .filter(word => word.count < state.learnedThreshold);
                }
                
                if (wordsPool.length === 0) {
                    state.currentWordIndex = null;
                    return;
                }
                
                wordsPool.sort((a,b) => a.count - b.count);
                const minCount = wordsPool[0].count;
                const leastSeenWords = wordsPool.filter(word => word.count === minCount);
                const randomIndex = Math.floor(Math.random() * leastSeenWords.length);
                state.currentWordIndex = leastSeenWords[randomIndex].originalIndex;
            };

            const startNextExercise = () => {
                selectNextWord();
                if (state.currentWordIndex === null) {
                    state.currentQuestion = {};
                    renderExercise();
                    return;
                }

                let exerciseType = state.exerciseMode;
                if (exerciseType === 'mix') {
                    const types = ['flashcard-es-fr', 'flashcard-fr-es', 'qcm'];
                    exerciseType = types[Math.floor(Math.random() * types.length)];
                }
                
                state.currentQuestion = { type: exerciseType, word: state.words[state.currentWordIndex] };

                if (exerciseType === 'qcm') {
                    try {
                        const correctWord = state.currentQuestion.word;
                        if (state.words.length < 4) throw new Error("Pas assez de mots pour un QCM.");
                        
                        const distractors = [];
                        const wordPool = state.words.filter(w => w.spanish !== correctWord.spanish && w.french);

                        while (distractors.length < 3 && wordPool.length > 0) {
                            const randIdx = Math.floor(Math.random() * wordPool.length);
                            distractors.push(wordPool.splice(randIdx, 1)[0]);
                        }
                        
                        if (!correctWord || !correctWord.french) throw new Error("Mot actuel invalide.");
                        
                        const options = [correctWord, ...distractors].map(w => w.french);
                        if (options.length < 4) throw new Error("Pas assez d'options pour un QCM.");
                        
                        state.currentQuestion.options = options.sort(() => Math.random() - 0.5);

                    } catch (error) {
                        console.warn(`Impossible de cr√©er un QCM, bascule vers Flashcard: ${error.message}`);
                        state.currentQuestion.type = 'flashcard-es-fr';
                    }
                }
                renderExercise();
            };
            
            const normalizeUserAnswer = (answer) => answer.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[.,!?¬ø]/g, '').trim().replace(/\s+/g, ' ');

            const getPossibleAnswers = (frenchAnswer) => {
                let base = frenchAnswer.toLowerCase().trim();
                let alternatives = base.split(/\s*\/\s*/);
                let finalAnswers = [];
                alternatives.forEach(alt => {
                    const match = alt.match(/(.*)\((.+)\)$/); 
                    if (match) {
                        finalAnswers.push(match[1].trim());
                        finalAnswers.push(match[1].trim() + match[2]);
                    } else {
                        finalAnswers.push(alt.trim());
                    }
                });
                return finalAnswers.map(ans => normalizeUserAnswer(ans));
            };

            const getQuestionText = () => {
                const { type, word } = state.currentQuestion;
                if (type === 'qcm' || type === 'flashcard-es-fr') {
                    return word.spanish;
                } else if (type === 'flashcard-fr-es') {
                    return word.french;
                }
                return '';
            };

            const handleAcceptAnswer = () => {
                const { word } = state.currentQuestion;
                
                // Compter comme correct
                word.count++;
                state.sessionStats.accepted++;
                state.sessionStats.total++;
                
                // Ajouter aux mots corrects si pas d√©j√† pr√©sent
                if (!state.sessionCorrect.find(w => w.spanish === word.spanish)) {
                    state.sessionCorrect.push({ ...word });
                }
                
                // Retirer des erreurs de session si pr√©sent
                state.sessionMistakes = state.sessionMistakes.filter(w => w.spanish !== word.spanish);
                
                // V√©rifier si le mot est maintenant ma√Ætris√©
                if (word.count >= state.learnedThreshold) {
                    // Le mot sera automatiquement dans la section "ma√Ætris√©" lors du prochain renderDashboard()
                }
                
                updateSessionStats();
                saveState();
                renderDashboard();
                
                // Masquer les boutons et pr√©parer le suivant
                acceptAnswerBtn.classList.add('hidden');
                nextBtn.classList.remove('hidden');
                nextBtn.focus();
                
                feedback.innerHTML = `
                    <div class="feedback-box border-green-500 bg-green-50">
                        <div class="text-sm text-gray-700 mb-2">
                            <strong>Question :</strong> ${getQuestionText()}
                        </div>
                        <div class="text-green-600 font-bold">‚úÖ R√©ponse accept√©e ! üëç</div>
                    </div>
                `;
            };

            const handleDontKnow = () => {
                const { word } = state.currentQuestion;
                
                // Marquer comme incorrect
                word.count = 0;
                state.sessionStats.unknown++;
                state.sessionStats.total++;
                
                // Ajouter aux mots √† r√©viser si pas d√©j√† pr√©sent
                if (!state.sessionMistakes.find(w => w.spanish === word.spanish)) {
                    state.sessionMistakes.push({ ...word });
                }
                
                // Afficher la r√©ponse avec question
                const correctAnswerText = state.currentQuestion.type === 'flashcard-fr-es' ? word.spanish : word.french;
                feedback.innerHTML = `
                    <div class="feedback-box border-orange-500 bg-orange-50">
                        <div class="text-sm text-gray-700 mb-2">
                            <strong>Question :</strong> ${getQuestionText()}
                        </div>
                        <div class="text-orange-600 font-bold">ü§∑ La r√©ponse √©tait : <strong class="text-blue-600">${correctAnswerText}</strong></div>
                    </div>
                `;
                
                // D√©sactiver les contr√¥les
                answerInput.disabled = true;
                checkBtn.classList.add('hidden');
                dontKnowBtn.classList.add('hidden');
                document.querySelectorAll('.qcm-option-btn').forEach(btn => btn.disabled = true);
                
                // Montrer la carte retourn√©e pour les flashcards
                if (state.currentQuestion.type !== 'qcm') {
                    exerciseContainer.querySelector('.card')?.classList.add('is-flipped');
                }
                
                // Colorer les options QCM
                if (state.currentQuestion.type === 'qcm') {
                    document.querySelectorAll('.qcm-option-btn').forEach(btn => {
                        if (btn.textContent === correctAnswerText) {
                            btn.className += ' bg-blue-200 border-blue-500';
                        }
                    });
                }
                
                updateSessionStats();
                nextBtn.classList.remove('hidden');
                nextBtn.focus();
                saveState();
                renderDashboard();
            };

            const handleAnswer = (userAnswer) => {
                state.lastUserAnswer = userAnswer;
                answerInput.disabled = true;
                checkBtn.classList.add('hidden');
                dontKnowBtn.classList.add('hidden');
                checkBtn.onclick = null;
                dontKnowBtn.onclick = null;
                document.querySelectorAll('.qcm-option-btn').forEach(btn => btn.disabled = true);

                const { type, word } = state.currentQuestion;
                let isCorrect = false;
                let correctAnswerText = '';

                if (type === 'flashcard-es-fr' || type === 'qcm') {
                    correctAnswerText = word.french;
                    const possibleCorrect = getPossibleAnswers(correctAnswerText);
                    isCorrect = possibleCorrect.includes(normalizeUserAnswer(userAnswer));
                } else if (type === 'flashcard-fr-es') {
                    correctAnswerText = word.spanish;
                    isCorrect = normalizeUserAnswer(userAnswer) === normalizeUserAnswer(correctAnswerText);
                }

                state.sessionStats.total++;

                if (isCorrect) {
                    word.count++;
                    state.sessionStats.correct++;
                    
                    // Ajouter aux mots corrects si pas d√©j√† pr√©sent
                    if (!state.sessionCorrect.find(w => w.spanish === word.spanish)) {
                        state.sessionCorrect.push({ ...word });
                    }
                    
                    // Retirer des erreurs de session si pr√©sent
                    state.sessionMistakes = state.sessionMistakes.filter(w => w.spanish !== word.spanish);
                    
                    feedback.innerHTML = `
                        <div class="feedback-box border-green-500 bg-green-50">
                            <div class="text-sm text-gray-700 mb-2">
                                <strong>Question :</strong> ${getQuestionText()}
                            </div>
                            <div class="text-sm text-gray-700 mb-2">
                                <strong>Votre r√©ponse :</strong> ${userAnswer}
                            </div>
                            <div class="text-green-600 font-bold">‚úÖ Correct ! üëç</div>
                        </div>
                    `;
                    nextBtn.classList.remove('hidden');
                    nextBtn.focus();
                } else {
                    word.count = 0;
                    state.sessionStats.incorrect++;
                    // Ajouter aux mots √† r√©viser si pas d√©j√† pr√©sent
                    if (!state.sessionMistakes.find(w => w.spanish === word.spanish)) {
                        state.sessionMistakes.push({ ...word });
                    }
                    feedback.innerHTML = `
                        <div class="feedback-box border-red-500 bg-red-50">
                            <div class="text-sm text-gray-700 mb-2">
                                <strong>Question :</strong> ${getQuestionText()}
                            </div>
                            <div class="text-sm text-gray-700 mb-2">
                                <strong>Votre r√©ponse :</strong> ${userAnswer}
                            </div>
                            <div class="text-red-600 font-bold">‚ùå Incorrect. La r√©ponse √©tait : <strong class="text-blue-600">${correctAnswerText}</strong></div>
                        </div>
                    `;
                    
                    // Montrer le bouton "Accepter ma r√©ponse"
                    acceptAnswerBtn.classList.remove('hidden');
                    acceptAnswerBtn.onclick = handleAcceptAnswer;
                    nextBtn.classList.remove('hidden');
                }
                
                if (type === 'qcm') {
                    document.querySelectorAll('.qcm-option-btn').forEach(btn => {
                        if (btn.textContent === correctAnswerText) btn.className += ' bg-green-200 border-green-500';
                        else if (btn.textContent === userAnswer && !isCorrect) btn.className += ' bg-red-200 border-red-500';
                    });
                } else {
                    exerciseContainer.querySelector('.card')?.classList.add('is-flipped');
                }
                
                updateSessionStats();
                saveState();
                renderDashboard();
            };
            
            const restartApp = () => {
                state.sessionMistakes = []; // Reset des erreurs de session
                state.sessionCorrect = []; // Reset des mots corrects de session
                resetSessionStats(); // Reset des statistiques
                renderDashboard();
                startNextExercise();
            };

            const init = async () => {
                const userProvidedUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbVypWe5G4ANd6EOF6Qv3zevzVB0JndrvFe4S88_ctRAp--7Ln2jxYJQtTjRN7tDMJ2dweBB57LMm/pub?gid=0&single=true&output=csv";
                sheetUrlInput.value = userProvidedUrl;
                
                document.querySelector(`[data-mode="${state.exerciseMode}"]`).classList.add('active');
                
                resetSessionStats();
                await fetchAndParseSheet(userProvidedUrl);
            };
            
            nextBtn.addEventListener('click', startNextExercise);
            loadSheetBtn.addEventListener('click', () => { if (sheetUrlInput.value.trim()) fetchAndParseSheet(sheetUrlInput.value.trim()); });
            
            // Gestionnaire du filtre de r√©vision
            reviewFilterBtn.addEventListener('click', () => {
                state.reviewFilter = !state.reviewFilter;
                if (state.reviewFilter) {
                    state.correctFilter = false; // D√©sactiver l'autre filtre
                    correctFilterBtn.classList.remove('active-correct');
                    correctFilterBtn.textContent = '‚úÖ R√©viser uniquement les mots corrects';
                    
                    reviewFilterBtn.classList.add('active-review');
                    reviewFilterBtn.textContent = 'üéØ Mode r√©vision activ√©';
                } else {
                    reviewFilterBtn.classList.remove('active-review');
                    reviewFilterBtn.textContent = 'üéØ R√©viser uniquement les mots √† r√©viser';
                }
                startNextExercise(); // Red√©marrer avec le nouveau filtre
            });

            // Gestionnaire du filtre des mots corrects
            correctFilterBtn.addEventListener('click', () => {
                state.correctFilter = !state.correctFilter;
                if (state.correctFilter) {
                    state.reviewFilter = false; // D√©sactiver l'autre filtre
                    reviewFilterBtn.classList.remove('active-review');
                    reviewFilterBtn.textContent = 'üéØ R√©viser uniquement les mots √† r√©viser';
                    
                    correctFilterBtn.classList.add('active-correct');
                    correctFilterBtn.textContent = '‚úÖ Mode mots corrects activ√©';
                } else {
                    correctFilterBtn.classList.remove('active-correct');
                    correctFilterBtn.textContent = '‚úÖ R√©viser uniquement les mots corrects';
                }
                startNextExercise(); // Red√©marrer avec le nouveau filtre
            });
            
            modeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    state.exerciseMode = button.dataset.mode;
                    modeButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    restartApp();
                });
            });

            // Gestionnaire d'√©v√©nements pour la touche Entr√©e - CORRIG√â
            document.addEventListener('keyup', (event) => {
                if (event.key !== 'Enter') return;
                
                // Si le bouton "Mot Suivant" est visible, l'activer
                if (!nextBtn.classList.contains('hidden')) {
                    nextBtn.click();
                }
                // Sinon, si l'input est actif et le bouton "V√©rifier" est visible, v√©rifier la r√©ponse
                else if (document.activeElement === answerInput && !checkBtn.classList.contains('hidden')) {
                    checkBtn.click();
                }
            });
            
            init();
        });
    </script>
</body>
</html>
